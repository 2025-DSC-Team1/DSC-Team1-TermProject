<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ê³µìœ  í…ìŠ¤íŠ¸ ì—ë””í„°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
        }
        .editor-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
        #editor {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
            resize: vertical;
        }
        .connection-status {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        .button-group {
            margin: 10px 0;
        }
        button {
            padding: 8px 12px;
            margin-right: 5px;
            cursor: pointer;
        }
        #log {
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
        }
        .user-info {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ì‹¤ì‹œê°„ ê³µìœ  í…ìŠ¤íŠ¸ ì—ë””í„°</h1>

    <div class="button-group">
        <button onclick="connect()">ì—°ê²°</button>
        <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>

    <div id="status" class="connection-status disconnected">ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆë¨</div>

    <div class="editor-container">
        <h3>ê³µìœ  í…ìŠ¤íŠ¸ í¸ì§‘</h3>
        <textarea id="editor" oninput="handleTextChange(event)" disabled></textarea>
        <div class="user-info">í˜„ì¬ ì‚¬ìš©ì ID: <span id="user-id">ì—°ê²°ë˜ì§€ ì•ŠìŒ</span></div>
    </div>

    <div id="log">
        <strong>ğŸ“¨ ë©”ì‹œì§€ ë¡œê·¸:</strong>
    </div>
</div>

<script>
    let socket;
    let editorElement = document.getElementById("editor");
    let statusElement = document.getElementById("status");
    let userIdElement = document.getElementById("user-id");

    // ì—ë””í„°ì˜ ì´ì „ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜
    let lastEditorState = "";
    let isLocalChange = false;

    function logMessage(message) {
        const logDiv = document.getElementById("log");
        logDiv.innerText += message + '\n';
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(status, message) {
        statusElement.className = "connection-status " + status;
        statusElement.innerText = "ì—°ê²° ìƒíƒœ: " + message;
    }

    function connect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            logMessage("âš ï¸ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        if (socket && socket.readyState === WebSocket.CONNECTING) {
            logMessage("â³ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...");
            return;
        }

        updateStatus("connecting", "ì—°ê²° ì¤‘...");

        // WebSocket í”„ë¡œí† ì½œ ìë™ ì„ íƒ (http->ws, https->wss)
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            logMessage("âœ… ì„œë²„ì— ì—°ê²°ë¨");
            updateStatus("connected", "ì—°ê²°ë¨");
            editorElement.disabled = false;

            // ì„œë²„ì— ì´ˆê¸° ë™ê¸°í™” ìš”ì²­
            requestSyncFromServer();
        };

        socket.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);

                if (data.type === "init") {
                    // ì´ˆê¸° í…ìŠ¤íŠ¸ ì„¤ì •
                    isLocalChange = true;
                    editorElement.value = data.text;
                    lastEditorState = data.text;
                    isLocalChange = false;
                    logMessage("ğŸ“© ì„œë²„ì—ì„œ ì´ˆê¸° í…ìŠ¤íŠ¸ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.");
                }
                else if (data.type === "add" || data.type === "delete" || data.type === "edit") {
                    // ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì˜ ë³€ê²½ì‚¬í•­ ì ìš©
                    if (!isLocalChange) {
                        isLocalChange = true;
                        editorElement.value = data.fullText;
                        lastEditorState = data.fullText;
                        isLocalChange = false;
                        logMessage(`ğŸ“© ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì˜ í…ìŠ¤íŠ¸ ë³€ê²½ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.type}`);
                    }
                }
                else {
                    // ì¼ë°˜ ë©”ì‹œì§€
                    logMessage("ğŸ“© " + e.data);

                    // ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ ID í™•ì¸
                    if (e.data.includes("client connected:")) {
                        const id = e.data.split("client connected: ")[1];
                        if (id === socket.id) {
                            userIdElement.innerText = id;
                        }
                    }
                }
            } catch (error) {
                // JSONì´ ì•„ë‹Œ ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
                logMessage("ğŸ“© " + e.data);
            }
        };

        socket.onclose = () => {
            logMessage("âŒ ì—°ê²° ì¢…ë£Œ");
            updateStatus("disconnected", "ì—°ê²° ì•ˆë¨");
            editorElement.disabled = true;
            userIdElement.innerText = "ì—°ê²°ë˜ì§€ ì•ŠìŒ";
            socket = null;
        };

        socket.onerror = (e) => {
            logMessage("ğŸš¨ ì—ëŸ¬ ë°œìƒ: " + e.message);
            updateStatus("disconnected", "ì˜¤ë¥˜ ë°œìƒ");
        };
    }

    function disconnect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
        } else {
            logMessage("âš ï¸ ì—°ê²°ì´ ì´ë¯¸ ë‹«í˜€ìˆìŠµë‹ˆë‹¤.");
        }
    }

    function requestSyncFromServer() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            const syncRequest = {
                type: "sync"
            };
            socket.send(JSON.stringify(syncRequest));
            logMessage("ğŸ“¤ ì„œë²„ì— í…ìŠ¤íŠ¸ ë™ê¸°í™” ìš”ì²­");
        }
    }

    // í…ìŠ¤íŠ¸ ë³€ê²½ ê°ì§€ ë° ì„œë²„ë¡œ ì „ì†¡
    function handleTextChange(event) {
        if (isLocalChange) return; // ì„œë²„ì—ì„œ ì˜¨ ë³€ê²½ì‚¬í•­ì€ ë‹¤ì‹œ ì„œë²„ë¡œ ë³´ë‚´ì§€ ì•ŠìŒ

        if (socket && socket.readyState === WebSocket.OPEN) {
            const currentText = event.target.value;
            const previousText = lastEditorState;

            // í…ìŠ¤íŠ¸ ë³€ê²½ ë¶„ì„
            if (currentText.length > previousText.length) {
                // í…ìŠ¤íŠ¸ ì¶”ê°€ ë˜ëŠ” í¸ì§‘

                // ê°„ë‹¨í•œ íƒ€ì´í•‘ ê°ì§€ (ëì— ì¶”ê°€)
                if (currentText.startsWith(previousText)) {
                    const addedText = currentText.substring(previousText.length);
                    const position = previousText.length;

                    const addMessage = {
                        type: "add",
                        position: position,
                        text: addedText
                    };
                    socket.send(JSON.stringify(addMessage));
                    logMessage(`ğŸ“¤ í…ìŠ¤íŠ¸ ì¶”ê°€: "${addedText}" (ìœ„ì¹˜: ${position})`);
                }
                // ì¤‘ê°„ì— ì‚½ì… ë˜ëŠ” í¸ì§‘ (ë³µì¡í•œ ê²½ìš°)
                else {
                    const editMessage = {
                        type: "edit",
                        start: 0,
                        end: previousText.length,
                        text: currentText
                    };
                    socket.send(JSON.stringify(editMessage));
                    logMessage("ğŸ“¤ í…ìŠ¤íŠ¸ ì „ì²´ í¸ì§‘");
                }
            }
            else if (currentText.length < previousText.length) {
                // í…ìŠ¤íŠ¸ ì‚­ì œ

                // ê°„ë‹¨í•œ ë°±ìŠ¤í˜ì´ìŠ¤ ê°ì§€ (ëì—ì„œ ì‚­ì œ)
                if (previousText.startsWith(currentText)) {
                    const start = currentText.length;
                    const end = previousText.length;

                    const deleteMessage = {
                        type: "delete",
                        start: start,
                        end: end
                    };
                    socket.send(JSON.stringify(deleteMessage));
                    logMessage(`ğŸ“¤ í…ìŠ¤íŠ¸ ì‚­ì œ: ìœ„ì¹˜ ${start}~${end}`);
                }
                // ì¤‘ê°„ì—ì„œ ì‚­ì œ (ë³µì¡í•œ ê²½ìš°)
                else {
                    const editMessage = {
                        type: "edit",
                        start: 0,
                        end: previousText.length,
                        text: currentText
                    };
                    socket.send(JSON.stringify(editMessage));
                    logMessage("ğŸ“¤ í…ìŠ¤íŠ¸ ì „ì²´ í¸ì§‘");
                }
            }
            else if (currentText !== previousText) {
                // ê°™ì€ ê¸¸ì´ì§€ë§Œ ë‚´ìš©ì´ ë‹¤ë¥¸ ê²½ìš° (ë¶™ì—¬ë„£ê¸° ë“±)
                const editMessage = {
                    type: "edit",
                    start: 0,
                    end: previousText.length,
                    text: currentText
                };
                socket.send(JSON.stringify(editMessage));
                logMessage("ğŸ“¤ í…ìŠ¤íŠ¸ ì „ì²´ í¸ì§‘");
            }

            lastEditorState = currentText;
        } else {
            logMessage("âš ï¸ ì—°ê²°ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }
</script>
</body>
</html>