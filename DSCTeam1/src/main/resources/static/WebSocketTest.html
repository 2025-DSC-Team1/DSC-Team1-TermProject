<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DSC 1íŒ€ í˜‘ì—… í…ìŠ¤íŠ¸ í¸ì§‘ê¸°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #editor {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆì„ ìœ„í•´ ì¶”ê°€ */
            box-sizing: border-box;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        .button-group {
            margin: 10px 0;
            text-align: center;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        #status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        #log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 150px;
            overflow-y: scroll;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<h1>í˜‘ì—… í…ìŠ¤íŠ¸ í¸ì§‘ê¸°</h1>

<div class="button-group">
    <button onclick="connect()">ì—°ê²°</button>
    <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
</div>

<div id="status" class="disconnected">ì—°ê²° ìƒíƒœ: ì—°ê²° ì•ˆë¨</div>

<div id="editor" contenteditable="true"></div>

<div id="log">
    <strong>ğŸ“¨ ë©”ì‹œì§€ ë¡œê·¸:</strong>
</div>

<script>
    let socket;
    let editorElement = document.getElementById("editor");
    let statusElement = document.getElementById("status");
    let isLocalChange = false;
    let lastContent = "";

    function logMessage(message) {
        const logDiv = document.getElementById("log");
        logDiv.innerText += "\n" + message;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(status, message) {
        statusElement.className = status;
        statusElement.innerText = "ì—°ê²° ìƒíƒœ: " + message;
    }

    function connect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            logMessage("âš ï¸ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        if (socket && socket.readyState === WebSocket.CONNECTING) {
            logMessage("â³ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...");
            return;
        }

        updateStatus("connecting", "ì—°ê²° ì¤‘...");
        editorElement.contentEditable = "false";

        // WebSocket í”„ë¡œí† ì½œ ìë™ ì„ íƒ (http->ws, https->wss)
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            logMessage("âœ… ì„œë²„ì— ì—°ê²°ë¨");
            updateStatus("connected", "ì—°ê²°ë¨");
            editorElement.contentEditable = "true";

            // ì„œë²„ì— ì´ˆê¸° ë™ê¸°í™” ìš”ì²­
            requestSyncFromServer();
        };

        socket.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);

                if (data.type === "init") {
                    // ì´ˆê¸° í…ìŠ¤íŠ¸ ì„¤ì •
                    isLocalChange = true;
                    editorElement.textContent = data.text;
                    lastContent = data.text;
                    isLocalChange = false;
                    logMessage("ğŸ“© ì„œë²„ì—ì„œ ì´ˆê¸° í…ìŠ¤íŠ¸ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.");
                }
                else if (data.type === "add" || data.type === "delete" || data.type === "edit") {
                    // ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì˜ ë³€ê²½ì‚¬í•­ ì ìš©
                    if (!isLocalChange) {
                        isLocalChange = true;
                        editorElement.textContent = data.fullText;
                        lastContent = data.fullText;
                        isLocalChange = false;
                        logMessage(`ğŸ“© ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì˜ í…ìŠ¤íŠ¸ ë³€ê²½ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.type}`);
                    }
                }
                else {
                    // ì¼ë°˜ ë©”ì‹œì§€
                    logMessage("ğŸ“© " + e.data);
                }
            } catch (error) {
                // JSONì´ ì•„ë‹Œ ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
                logMessage("ğŸ“© " + e.data);
            }
        };

        socket.onclose = () => {
            logMessage("âŒ ì—°ê²° ì¢…ë£Œ");
            updateStatus("disconnected", "ì—°ê²° ì•ˆë¨");
            editorElement.contentEditable = "false";
            socket = null;
        };

        socket.onerror = (e) => {
            logMessage("ğŸš¨ ì—ëŸ¬ ë°œìƒ: " + e.message);
            updateStatus("disconnected", "ì˜¤ë¥˜ ë°œìƒ");
        };
    }

    function disconnect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
        } else {
            logMessage("âš ï¸ ì—°ê²°ì´ ì´ë¯¸ ë‹«í˜€ìˆìŠµë‹ˆë‹¤.");
        }
    }

    function requestSyncFromServer() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            const syncRequest = {
                type: "sync"
            };
            socket.send(JSON.stringify(syncRequest));
            logMessage("ğŸ“¤ ì„œë²„ì— í…ìŠ¤íŠ¸ ë™ê¸°í™” ìš”ì²­");
        }
    }

    // í…ìŠ¤íŠ¸ ë³€ê²½ ê°ì§€ ë° ì„œë²„ë¡œ ì „ì†¡
    editorElement.addEventListener('input', (event) => {
        if (isLocalChange || !socket || socket.readyState !== WebSocket.OPEN) return;

        const currentContent = editorElement.textContent;

        // ì „ì²´ ë‚´ìš©ì´ ë³€ê²½ëœ ê²½ìš° - í¸ì§‘ ë©”ì‹œì§€ ì „ì†¡
        const editMessage = {
            type: "edit",
            start: 0,
            end: lastContent.length,
            text: currentContent
        };

        socket.send(JSON.stringify(editMessage));
        logMessage("ğŸ“¤ í…ìŠ¤íŠ¸ ë³€ê²½ ì „ì†¡");

        lastContent = currentContent;
    });

    // ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
    editorElement.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€

            // í‘œì¤€ ë°©ì‹ì˜ ì¤„ë°”ê¿ˆ ì‚½ì…
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            const newLineNode = document.createTextNode('\n');
            range.deleteContents();
            range.insertNode(newLineNode);

            // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì •
            range.setStartAfter(newLineNode);
            range.setEndAfter(newLineNode);
            selection.removeAllRanges();
            selection.addRange(range);

            // ë³€ê²½ ë‚´ìš© ì„œë²„ë¡œ ì „ì†¡
            if (socket && socket.readyState === WebSocket.OPEN) {
                const currentContent = editorElement.textContent;
                const editMessage = {
                    type: "edit",
                    start: 0,
                    end: lastContent.length,
                    text: currentContent
                };
                socket.send(JSON.stringify(editMessage));
                lastContent = currentContent;
            }
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° ë²„íŠ¼ ê°•ì¡°
    window.onload = function() {
        const connectButton = document.querySelector('.button-group button:first-child');
        connectButton.focus();
    };
</script>
</body>
</html>